{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-md-8">
        <h3>Historical Readings</h3>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                {% if start_idx and end_idx %}
                <p class="mb-0 text-muted">
                    Showing <strong>{{ start_idx }}</strong>–<strong>{{ end_idx }}</strong>
                    of page {{ page }} / {{ total_pages }}
                </p>
                {% else %}
                <p class="mb-0 text-muted">No readings to show</p>
                {% endif %}
            </div>

            <div class="d-flex align-items-center">

                <!-- Per-page selection -->
                <form class="me-2" method="get" action="{{ url_for('dashboard') }}">
                    <!-- reset to first page when changing per_page -->
                    <input type="hidden" name="page" value="1">
                    <div class="input-group input-group-sm">
                        <label class="input-group-text" for="per_page_select">Per page</label>
                        <select class="form-select" id="per_page_select" name="per_page" onchange="this.form.submit()">
                            <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
                            <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                            <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                            <option value="200" {% if per_page==200 %}selected{% endif %}>200</option>
                        </select>
                    </div>
                </form>

                <!-- Pagination -->
                <nav aria-label="pagination">
                    <ul class="pagination pagination-sm mb-0">

                        <li class="page-item {% if page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('dashboard', page=1, per_page=per_page) }}">First</a>
                        </li>

                        <li class="page-item {% if not has_prev %}disabled{% endif %}">
                            <a class="page-link"
                                href="{% if has_prev %}{{ url_for('dashboard', page=page-1, per_page=per_page) }}{% endif %}">Previous</a>
                        </li>

                        <li class="page-item disabled">
                            <span class="page-link">Page {{ page }}</span>
                        </li>

                        <li class="page-item {% if not has_next %}disabled{% endif %}">
                            <a class="page-link"
                                href="{% if has_next %}{{ url_for('dashboard', page=page+1, per_page=per_page) }}{% endif %}">Next</a>
                        </li>

                        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                            <a class="page-link"
                                href="{{ url_for('dashboard', page=total_pages, per_page=per_page) }}">Last</a>
                        </li>

                    </ul>
                </nav>

            </div>
        </div>

        {% if readings %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Timestamp (UTC)</th>
                        <th>Temperature (°C)</th>
                        <th>Humidity (%)</th>
                        <th>Pressure (hPa)</th>
                        <th>Raw</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in readings %}
                    <tr>
                        <td>{{ r._ts_display }}</td>
                        <td>{{ r.temperature if r.temperature is defined else "—" }}</td>
                        <td>{{ r.humidity if r.humidity is defined else "—" }}</td>
                        <td>{{ r.pressure if r.pressure is defined else "—" }}</td>

                        <td>
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                                data-bs-target="#raw{{ loop.index0 + start_idx }}">
                                View
                            </button>
                            <div class="collapse mt-2" id="raw{{ loop.index0 + start_idx }}">
                                <pre style="white-space: pre-wrap;">{{ r | tojson(indent=2) }}</pre>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            No readings found for device <strong>{{ device_id }}</strong>.
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <h4>Publish Command</h4>
        <form method="post" action="{{ url_for('publish_command') }}">

            <!-- Topic placeholder matches server default -->
            <div class="mb-3">
                <label class="form-label">Topic</label>
                <input class="form-control" name="topic" placeholder="devices/station-001/command">
                <div class="form-text">
                    Defaults to <code>devices/station-001/command</code> if left blank.
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">JSON Payload</label>
                <textarea class="form-control" name="payload" rows="4"
                    placeholder='{"action":"request_health_check"}'></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Quick Command</label>
                <input class="form-control" name="command" placeholder="ToggleDataSend">
            </div>

            <button class="btn btn-primary" type="submit">Publish</button>
        </form>
    </div>
</div>

<style>
    ::placeholder {
        opacity: 0.7 !important;
        color: inherit !important;
    }
</style>

{% endblock %}